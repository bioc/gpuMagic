<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml">

<head>

<meta charset="utf-8" />
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<meta name="generator" content="pandoc" />

<meta name="viewport" content="width=device-width, initial-scale=1">

<meta name="author" content="Jiefei Wang" />

<meta name="date" content="2018-10-21" />

<title>gpuMagic quick start guide</title>



<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
div.sourceCode { overflow-x: auto; }
table.sourceCode, tr.sourceCode, td.lineNumbers, td.sourceCode {
  margin: 0; padding: 0; vertical-align: baseline; border: none; }
table.sourceCode { width: 100%; line-height: 100%; }
td.lineNumbers { text-align: right; padding-right: 4px; padding-left: 4px; color: #aaaaaa; border-right: 1px solid #aaaaaa; }
td.sourceCode { padding-left: 5px; }
code > span.kw { color: #007020; font-weight: bold; } /* Keyword */
code > span.dt { color: #902000; } /* DataType */
code > span.dv { color: #40a070; } /* DecVal */
code > span.bn { color: #40a070; } /* BaseN */
code > span.fl { color: #40a070; } /* Float */
code > span.ch { color: #4070a0; } /* Char */
code > span.st { color: #4070a0; } /* String */
code > span.co { color: #60a0b0; font-style: italic; } /* Comment */
code > span.ot { color: #007020; } /* Other */
code > span.al { color: #ff0000; font-weight: bold; } /* Alert */
code > span.fu { color: #06287e; } /* Function */
code > span.er { color: #ff0000; font-weight: bold; } /* Error */
code > span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
code > span.cn { color: #880000; } /* Constant */
code > span.sc { color: #4070a0; } /* SpecialChar */
code > span.vs { color: #4070a0; } /* VerbatimString */
code > span.ss { color: #bb6688; } /* SpecialString */
code > span.im { } /* Import */
code > span.va { color: #19177c; } /* Variable */
code > span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code > span.op { color: #666666; } /* Operator */
code > span.bu { } /* BuiltIn */
code > span.ex { } /* Extension */
code > span.pp { color: #bc7a00; } /* Preprocessor */
code > span.at { color: #7d9029; } /* Attribute */
code > span.do { color: #ba2121; font-style: italic; } /* Documentation */
code > span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code > span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code > span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
</style>



<link href="data:text/css;charset=utf-8,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23header%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%20code%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" rel="stylesheet" type="text/css" />

</head>

<body>




<h1 class="title toc-ignore">gpuMagic quick start guide</h1>
<h4 class="author"><em>Jiefei Wang</em></h4>
<h4 class="date"><em>2018-10-21</em></h4>



<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>The gpuMagic package is designed for ultilizing the computing power of modern GPU. The package has the ability to compile the R code and implement the code on a GPU kernel. Therefore, it is easy for the user to design their own algorithm in pure R language and run the code in GPU. The package uses openCL as its parallel language so CPU parallel is also supported.</p>
<div id="program-setting" class="section level3">
<h3>Program setting</h3>
<p>To getting started, it is always a good practice to check your GPU avalability.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">getDeviceList</span>()
<span class="co">#&gt; Device 0: GeForce GTX 1070</span></code></pre></div>
<p>The devices listed above shows you the current avalable device in your computer, if you cannot see the device in your computer, you need to install the openCL driver obtained from the corresponding vender. The default device is the device 0, if you have multiple devices, you can query and choose your device by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="kw">getDeviceInfo</span>(<span class="dv">0</span>)
<span class="kw">setDevice</span>(<span class="dv">0</span>)</code></pre></div>
<p>The package also have a GPU resources manager. You can check your memory usage by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">.gpuResourcesManager$<span class="kw">getGPUusage</span>()
<span class="co">#&gt; Max GPU memory: 954MB</span>
<span class="co">#&gt; Current GPU usage: 0MB(0%)</span>
<span class="co">#&gt; Max Memory container length: 2147483647</span>
<span class="co">#&gt; Current container length: 0</span></code></pre></div>
<p>Please note that the maximum GPU memory is not your hardware memory, it is a limitation imposed by the package to prevent you from memory Overflow, you can change this setting by</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">oldLimit=.gpuResourcesManager$<span class="kw">setMaxMemLimit</span>(<span class="dv">4</span>*<span class="dv">10</span>^<span class="dv">9</span>)
.gpuResourcesManager$<span class="kw">getGPUusage</span>()
<span class="co">#&gt; Max GPU memory: 3815MB</span>
<span class="co">#&gt; Current GPU usage: 0MB(0%)</span>
<span class="co">#&gt; Max Memory container length: 2147483647</span>
<span class="co">#&gt; Current container length: 0</span></code></pre></div>
<p>The unit is byte and the old setting will be return. Now I have roughly 4GB memory availble in my program. After the proper device has been selected, you are ready to write your GPU code.</p>
</div>
<div id="warning" class="section level3">
<h3>Warning</h3>
<p>If you are using the Nvidia graphic card, it is a good practice to change your Timeout Detection and Recovery(TDR) setting as the driver will reset the graphic card if the function takes too long to run the code. The default setting is 2 seconds, which is too short for most operations. If you are using the other device such as Intel graphic card, you are safe to continue.</p>
<p>The setting can be found in NVIDIA Nsight. Change it to a larger number such as 20 second will be OK for most program.</p>
</div>
<div id="gpu-code" class="section level3">
<h3>GPU code</h3>
<p>The GPU code should be written as an R function and should be compatible with <strong>sapply</strong> function. Here is an example of matrix multiplication</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#C=A%*%B</span>
<span class="co">#Each time the function will compute an entry of C</span>
matMul&lt;-function(id,A,B){
  <span class="co">#find the index of the entry of C matrix</span>
  id=id<span class="dv">-1</span>
  j=<span class="kw">floor</span>(id/<span class="kw">nrow</span>(A))
  i=id-j*<span class="kw">nrow</span>(A)
  j=j<span class="dv">+1</span>
  i=i<span class="dv">+1</span>
  <span class="co">#initialize C[i,j]</span>
  C=<span class="dv">0</span>
  for(k in <span class="dv">1</span>:<span class="kw">ncol</span>(A)){
    C=C+A[i,k]*B[k,j]
  }
  <span class="kw">return</span>(C)
}</code></pre></div>
<p>You can test your function by using <strong>sapply</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n=<span class="dv">10</span>
m=<span class="dv">50</span>
k=<span class="dv">100</span>
A=<span class="kw">matrix</span>(<span class="kw">runif</span>(n*m),n,m)
B=<span class="kw">matrix</span>(<span class="kw">runif</span>(n*m),m,k)
C_sapply=<span class="kw">sapply</span>(<span class="dv">1</span>:(n*k),matMul,A,B)
<span class="co">#The internal matrix operation function in R</span>
C_internel=A%*%B
<span class="co">#Compute error</span>
<span class="kw">max</span>(<span class="kw">abs</span>(C_sapply-C_internel))
<span class="co">#&gt; [1] 0</span></code></pre></div>
<p>As you see here, the result from sapply is consistent with the result from the R internal matrix multiplication function. To run the above function in GPU, it can be simply achieved by changing <strong>sapply</strong> to <strong>gpuSapply</strong></p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">C_gpu=<span class="kw">gpuSapply</span>(<span class="dv">1</span>:(n*k),matMul,A,B)
<span class="co">#Compute error</span>
<span class="kw">max</span>(<span class="kw">abs</span>(C_gpu-C_internel))
<span class="co">#&gt; [1] 3.552714e-15</span></code></pre></div>
<p>That is all you need to do to run the GPU code! We can try a larger sample size to see the speed differences between GPU and R code.</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r">n=<span class="dv">1000</span>
m=<span class="dv">5000</span>
k=<span class="dv">10000</span>
A=<span class="kw">matrix</span>(<span class="kw">runif</span>(n*m),n,m)
B=<span class="kw">matrix</span>(<span class="kw">runif</span>(n*m),m,k)
<span class="kw">system.time</span>(
  <span class="kw">gpuSapply</span>(<span class="dv">1</span>:(n*k),matMul,A,B)
)
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;    1.06    1.81    2.89</span>
<span class="kw">system.time</span>(
  A%*%B
)
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   26.95    0.00   27.00</span></code></pre></div>
<p>In my compute the GPU(GTX 1070) code takes about 4 secs to finish and CPU(AMD razen 1600) takes 28 secs to finish, you get 7 times speed up in this matrix operation! The current package does not take any advantage of the GPU structure, but you are still able to outperform than the highly optimized CPU code with no effort.</p>
<p>As you can see, the package partially supports the matrix operation, so the parallel computing can be ran in a more coarse level, which makes the code a littile bit easier to read, but will have negative effect on the performance(Due to no optimization)</p>
<div class="sourceCode"><pre class="sourceCode r"><code class="sourceCode r"><span class="co">#C=A%*%B</span>
<span class="co">#Each time the function will compute a column of C</span>
matMul_coarse&lt;-function(j,A,B){
  C=<span class="kw">matrix</span>(<span class="dv">0</span>,<span class="kw">nrow</span>(A),<span class="dv">1</span>)
  for(i in <span class="dv">1</span>:<span class="kw">nrow</span>(A)){
    tmp=<span class="dv">0</span>
    for(k in <span class="dv">1</span>:<span class="kw">ncol</span>(A)){
      tmp=tmp+A[i,k]*B[k,j]
    }
    C[i]=tmp
  }
  <span class="kw">return</span>(C)
}

<span class="co">#Same matrix, but 2.5X slower</span>
<span class="kw">system.time</span>(
<span class="kw">gpuSapply</span>(<span class="dv">1</span>:k,matMul_coarse,A,B)
)
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;    1.84    8.38   10.33</span>
<span class="kw">system.time</span>(
  A%*%B
)
<span class="co">#&gt;    user  system elapsed </span>
<span class="co">#&gt;   27.36    0.00   27.36</span>
<span class="co">#compute error</span>
<span class="kw">max</span>(<span class="kw">abs</span>(<span class="kw">gpuSapply</span>(<span class="dv">1</span>:k,matMul_coarse,A,B)-A%*%B))
<span class="co">#&gt; [1] 1.136868e-12</span></code></pre></div>
</div>
</div>



<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
